from flask import Flask, render_template, request
import crawler, scanner
import sqlite3

app = Flask(__name__)

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/scan", methods=["POST"])
def scan():
    target_url = request.form["url"]

    # 1) Crawl forms
    forms = crawler.crawl_forms(target_url)

    # 2) Test each form input for XSS + SQLi
    if forms:
        for form in forms:
            action = form.get("action", "")
            method = (form.get("method") or "GET").upper()
            for input_tag in form.find_all("input"):
                input_name = input_tag.get("name")
                if not input_name:
                    continue
                scanner.test_xss(target_url, action, input_name, method)
                scanner.test_sqli(target_url, action, input_name, method)

    # 3) Check security headers on the main URL
    scanner.check_security_headers(target_url)

    # 4) Show results
    conn = sqlite3.connect("vulnerabilities.db")
    cur = conn.cursor()
    cur.execute("SELECT url, type, payload, timestamp FROM vulnerabilities ORDER BY id DESC")
    vulns = cur.fetchall()
    conn.close()

    return render_template("results.html", vulnerabilities=vulns)

if __name__ == "__main__":
    # Accessible from host too
    app.run(host="0.0.0.0", port=5000, debug=True)
